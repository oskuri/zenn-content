---
title: "仮想環境向けにVyOSを導入してみた"
emoji: "🌟"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: [VyOS,network]
published: true
---

どうも、とっても久しぶりの投稿です。自宅環境のネットワーク周りを大改造しておりまして、その一環で仮想環境上に仮想ルータであるVyOSを導入しました。
小難しいことはしていませんが、導入記録の一つとして記事にしておきます。

# VyOSのダウンロード
VyOSはOSSでダウンロードページからISOイメージの他、仮想環境用のテンプレートとしても配布されています。
vSphere環境で使っているので、OVAから展開してみたのですが、うまくいかないところがあったため、ISOイメージからインストールしています。
今回は[こちら](https://vyos.net/get/snapshots/)からダウンロードした vyos-1.3.0-rc5-amd64.iso を使って進めていきます。

# インストール
自身の環境に合わせて、ISOイメージで起動させていきます。
ログインプロンプトが表示されたら、ID,パスワードともvyosでログインします。
ログイン後、インストールコマンドを実行することで、インストール処理を進められます。
```
vyos@vyos:~$ install image
```
プロンプトにしたがって応答すればインストールが進められます。基本的にはデフォルトで良いかと。


#各種設定
インストール完了後に再起動させ、システム用の設定をいくつか入れていきます。
私自身がNW機器に不慣れで初めて知ったので一応記載しておきます。VyOSにはoperational mode(プロンプトが$)と、configuration mode(プロンプトが#)があり、設定時にはconfとコマンドを実行してから編集モードに移ってからsetコマンドなどを実行します。　編集モードにて発行したコマンドを設定に反映させるのはcommitコマンドです。編集モードでコマンドが失敗し、よくわからない状況になった場合はdiscardコマンドで前回のcommit以降に発行したコマンドを破棄させることができます。
編集モード中にexitコマンドを実行することで、operational modeに戻ることができます。以降、operational modeで実行する場合はプロンプト込みで記載します。明示しませんが設定モードでコマンド発行した場合は、適宜commitして下さい。諸々終わった後、編集モード中にsaveとすると、commitしている内容が/config/config.bootに出力されるようです。忘れずに。

## システム設定
以下で、VyOSのホスト名・ドメイン名を設定します。
```
set system host-name "ホスト名"
set system domain-name "ドメイン名"
```

タイムゾーンがdefaultでUTC表示のため、JSTに変更します。
```
set system time-zone Asia/Tokyo
```

## sshサーバーの有効化
```
set service ssh
```

## インターフェースの設定
設定前に、システム上のインターフェース名を確認しておきます。
```
vyos@VyOS-1:~$ show interfaces
Codes: S - State, L - Link, u - Up, D - Down, A - Admin Down
Interface        IP Address                        S/L  Description
---------        ----------                        ---  -----------
eth0                                               A/D  
lo               127.0.0.1/8                       u/u  
                 ::1/128
```
今回は、今後冗長化することも踏まえ、eth0に192.168.1.253/24を設定したいと思います。
コマンドはシンプルで、設定内容がすぐに理解できるようになっているようです。
```
set interfaces ethernet eth0 address 192.168.1.253/24
```

論理的に正しく接続されていれば、192.168.1.0/24からのpingに応答するようになります。

## ルーティングの設定
今回、VyOS配下のネットワークがインターネットに到達できるように、静的ルーティングを設定しておきます。
以下はインターネットルーターが192.168.1.1の場合なので、最後のnext-hopに該当するIPアドレスは自身の環境に置き換えて下さい。
```
set protocols static route 0.0.0.0/0 next-hop 192.168.1.1
```

# 参考にさせていただいたサイト
https://sig9.hatenablog.com/entry/2015/08/09/214338
ほぼまんまですが・・・。今回はPPPoE接続しないため、不要な部分を諸々削除しています。

https://docs.vyos.io/en/equuleus/index.html
VyOSのリファレンスです。バージョンによって若干コマンドも変わってくるので、うまくいかないところは公式のdocumentを参考に。



ではでは。
